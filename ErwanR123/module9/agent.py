import random

class Agent:
    """
    Agent FrozenLake-v1 (8x8, slippery)
    Politique fixe issue d'un entraînement Q-learning (α=0.02, γ=0.99, ε_end=0.05, decay=0.99).
    Compatible ML-Arena (aucune dépendance externe ni apprentissage à l'exécution).
    """
    TOLERANCE = 1e-5

    def __init__(self, env):
        self.env = env

        # Q-table apprise (64 états × 4 actions)
        self.q = [[0.29420995385560217, 0.2950634022720467, 0.294264371748934, 0.292005118609326],
                  [0.30260766833240094, 0.30252921011496864, 0.3063348442238046, 0.30303728824092435],
                  [0.30413644321670846, 0.31444525168285875, 0.32121601400641536, 0.3151170093074783],
                  [0.32922190454203654, 0.3299628666925131, 0.33870964281300375, 0.32435021886832976],
                  [0.35067493294855384, 0.35103205231633, 0.36187477989983363, 0.3459180657178977],
                  [0.36853061166782275, 0.3692578415676267, 0.38701590644541994, 0.3685439191670447],
                  [0.3895959438840707, 0.389621196584198, 0.4054396444753669, 0.3880749988106463],
                  [0.40733073465670694, 0.39230821043866465, 0.3900784436458687, 0.3863725607179519],
                  [0.29101726983769477, 0.2907994925705392, 0.2910708139035046, 0.29351206752249603],
                  [0.29407473720389976, 0.29458600393201834, 0.2949264719933318, 0.3004210919639085],
                  [0.2961404397875992, 0.2940007985759691, 0.30196432884961155, 0.3133460907802189],
                  [0.2342952456648879, 0.225624879435896, 0.20496204754952885, 0.33121734757643734],
                  [0.33538120205422334, 0.3401637082716003, 0.3478156929089452, 0.35533687711729006],
                  [0.36598906792528524, 0.3616942107065052, 0.38864166391269866, 0.36355811648800374],
                  [0.39252185484851465, 0.39745488248205424, 0.4140692395411607, 0.3999013594197966],
                  [0.4008374063977787, 0.431531390537535, 0.40984998597380173, 0.3985284185698438],
                  [0.25866382120486203, 0.25959369284982364, 0.25882630704825654, 0.2813091200341257],
                  [0.2751928273591275, 0.25417743384308866, 0.25606423838356934, 0.2597368034580428],
                  [0.26681414057072605, 0.22792845940427106, 0.23355151234614147, 0.22711846371039773],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.23522801815747674, 0.20934178555851846, 0.3178533732013346, 0.2321413572941838],
                  [0.20224553780082047, 0.27729113739213623, 0.2555381418916086, 0.3778004623564212],
                  [0.4037714173121307, 0.4104399915831587, 0.43643334435442593, 0.4103132594054086],
                  [0.43304476091704236, 0.4547874465496263, 0.4420652035913417, 0.4345106525539263],
                  [0.26596798487469553, 0.2469218550045634, 0.24701243615658877, 0.24950642197391018],
                  [0.2455293878916953, 0.23214296846560123, 0.23239501286727143, 0.23291094068548313],
                  [0.20656710210352167, 0.19819002699879248, 0.19943073012879176, 0.22248339182950733],
                  [0.11250617483191401, 0.16046350484863786, 0.1189518278356293, 0.1297740653871374],
                  [0.2299693605032685, 0.15991485242320733, 0.17621935703572217, 0.16964498226566394],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.26993781916065807, 0.35407388747666463, 0.4556884922773936, 0.2882445891919432],
                  [0.4837766989305572, 0.504995118961017, 0.477011564968623, 0.4558916783583016],
                  [0.2532950360745477, 0.24269268227701796, 0.24578256426889544, 0.24223194816066984],
                  [0.19727299454786376, 0.20078742710265599, 0.19990887017106815, 0.21191051271698796],
                  [0.15821593304730974, 0.12029378984119232, 0.12307993807721067, 0.11927169791265933],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.1645812491227076, 0.18925229039754685, 0.21654195986641717, 0.2055004309259897],
                  [0.16289879760780496, 0.27988360464196665, 0.2353087092978428, 0.22625331132859317],
                  [0.2550259733802866, 0.2727491082857408, 0.2746634045188174, 0.4409431660577232],
                  [0.5391747279511636, 0.5430920290986273, 0.6047019767301804, 0.5051795583106136],
                  [0.25432904540488543, 0.23930101881788265, 0.23053190107472743, 0.22853337172772095],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.09694842396972428, 0.11767211446455438, 0.0993456175994056, 0.09729413016077255],
                  [0.17081487852482813, 0.1659932679577362, 0.16190447732412883, 0.17483634447582602],
                  [0.23145365027627635, 0.17997364967860646, 0.20444292588434534, 0.18235120638879368],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.4932673356399401, 0.44276483939458433, 0.691705028610584, 0.42133293937908534],
                  [0.264372555546283, 0.26194982620837226, 0.25990692427294143, 0.2559933631330844],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.1846589080329749, 0.1862770186307141, 0.18895912419840366, 0.1861395502042241],
                  [0.12106992725526072, 0.12201608889477586, 0.12089805983280975, 0.12674124848433793],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.1945359642020071, 0.20031001078324748, 0.23090807500103386, 0.19072716087815655],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.47611352566857174, 0.5436311294499757, 0.8768064289021438, 0.5234680671251831],
                  [0.28114620430149856, 0.28113351938118925, 0.2812632881925352, 0.2811045465022166],
                  [0.2653829658006844, 0.27051855313823914, 0.2696855476507959, 0.2670506565172771],
                  [0.2524507530381983, 0.24617896770037465, 0.24409233115755297, 0.24832477386155366],
                  [0.5, 0.5, 0.5, 0.5],
                  [0.23699863786094263, 0.2348784540120545, 0.23676884962466216, 0.23937105065157935],
                  [0.4197697242829102, 0.429263474822547, 0.4189998885409268, 0.42092691782354485],
                  [0.47748411036813004, 0.6835169081743937, 0.5101017332060352, 0.4808238304991155],
                  [0.5, 0.5, 0.5, 0.5]]

        self.n_states = len(self.q)
        self.n_actions = len(self.q[0])

    def choose_action(self, observation, reward=0.0, terminated=False, truncated=False, info=None):
        s = int(observation)
        if s < 0 or s >= self.n_states:
            return self.env.action_space.sample()

        q_row = self.q[s]
        best_val = max(q_row)
        best_actions = [i for i, v in enumerate(q_row) if abs(v - best_val) < self.TOLERANCE]
        return random.choice(best_actions) if best_actions else self.env.action_space.sample()